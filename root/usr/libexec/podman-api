#!/bin/sh

action="$1"

SOCKET=$(uci -q get podman.globals.socket_path 2>/dev/null)
SOCKET="${SOCKET:-/run/podman/podman.sock}"
API_BASE="/v5.0.0/libpod"

# Route validation failures through plain text output
fail_validation() { echo "$1"; exit 1; }

. /usr/share/podman/validation.sh

case "$action" in
    logs)
        lines="$2"
        since="$3"
        containerId="$4"

        require_param containerId "$containerId"
        require_param lines "$lines"
        require_param since "$since"

        validate_path_safe_id "$containerId"
        validate_int "$lines"
        validate_int "$since"

        path="${API_BASE}/containers/${containerId}/logs"
        path="${path}?stdout=true&stderr=true&timestamps=true"

        [ "$lines" != "0" ] && path="${path}&tail=${lines}"
        [ "$since" != "0" ] && path="${path}&since=${since}"

        curl -s -m 60 --unix-socket "$SOCKET" -X GET "http://localhost${path}"
        ;;
    image_pull)
        image="$2"

        require_param image "$image"

        validate_image_ref "$image"

        image_enc=$(urlencode "$image")
        path="${API_BASE}/images/pull?reference=${image_enc}"

        curl -s -m 300 --unix-socket "$SOCKET" -X POST "http://localhost${path}"
        ;;
    volume_export)
        volumeName="$2"

        require_param volumeName "$volumeName"

        validate_volume_name "$volumeName"

        /usr/bin/podman volume export "$volumeName"
        ;;
    volume_import)
        volumeName="$2"
        volumeData="$4"
        compressed="$3"

        require_param volumeName "$volumeName"
        require_param volumeData "$volumeData"
        require_param compressed "$compressed"

        validate_volume_name "$volumeName"
        validate_base64_content "$volumeData"
        validate_int "$compressed"

        if [ "$compressed" = "1" ]; then
			data_decoded=$(echo "$volumeData" | base64 -d - | gunzip -c)
		else
			data_decoded=$(echo "$volumeData" | base64 -d -)
		fi
		decode_exit=$?

        if [ $decode_exit -ne 0 ]; then
            echo "Failed to decode import data"
            exit 1
        fi

        /usr/bin/podman volume exists "$volumeName" 2>/dev/null || \
            /usr/bin/podman volume create "$volumeName" > /dev/null 2>&1

        echo "$data_decoded" | /usr/bin/podman volume import "$volumeName" -
        exit_code=$?

        if [ $exit_code -ne 0 ]; then
            /usr/bin/podman volume rm "$volumeName" 2>/dev/null
            echo "Import failed"
            exit 1
        fi

        ;;
    *)
        echo "Unknown action: $action" >&2
        exit 1
        ;;
esac
