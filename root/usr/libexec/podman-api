#!/bin/sh

action="$1"

SOCKET=$(uci -q get podman.globals.socket_path 2>/dev/null)
SOCKET="${SOCKET:-/run/podman/podman.sock}"
API_BASE="/v5.0.0/libpod"

urlencode() {
	local string="$1" encoded="" char rest
	rest="$string"
	while [ -n "$rest" ]; do
		char="${rest%"${rest#?}"}"
		rest="${rest#?}"
		case "$char" in
			[-_.~a-zA-Z0-9:/@]) encoded="${encoded}${char}" ;;
			*) char=$(printf '%%%02x' "'$char")
			   encoded="${encoded}${char}" ;;
		esac
	done
	echo "$encoded"
}

validate_path_safe_id() {
	case "$1" in
		*[!a-zA-Z0-9_.:-]*)
            echo "Invalid id"
            exit 1
			;;
	esac
}

validate_int() {
	case "$1" in
		*[!0-9]*)
            echo "Invalid number"
            exit 1
			;;
	esac
}

validate_volume_name() {
	local name="$1"
	case "$name" in
		*[!a-zA-Z0-9_.-]*)
			echo 'Invalid volume name format'
			exit 1
			;;
	esac
}

validate_base64_content() {
    local data="$1"

    if ! printf '%s\n' "$data" | grep -Eq '^[A-Za-z0-9+/]*={0,2}$'; then
        echo 'Error: Invalid Base64 characters detected'
        exit 1
    fi

    local len=${#data}
    if [ $((len % 4)) -ne 0 ]; then
        echo "Error: Invalid Base64 length ($len). Must be a multiple of 4"
        exit 1
    fi
}

require_param() {
	local var_name="$1"
    local var_value="$2"
	if [ -z "$var_value" ]; then
		echo "Missing required parameter: $var_name"
		exit 1
	fi
}

case "$action" in
    logs)
        lines="$2"
        since="$3"
        containerId="$4"

        require_param containerId "$containerId"
        require_param lines "$lines"
        require_param since "$since"

        validate_path_safe_id "$containerId"
        validate_int "$lines"

        path="${API_BASE}/containers/${containerId}/logs"
        path="${path}?stdout=true&stderr=true&timestamps=true"

        [ "$lines" != "0" ] && path="${path}&tail=${lines}"
        [ "$since" != "0" ] && path="${path}&since=${since}"

        curl -s -m 60 --unix-socket "$SOCKET" -X GET "http://localhost${path}"
        ;;
    image_pull)
        image="$2"

        require_param image "$image"

        validate_path_safe_id "$image"

        image_enc=$(urlencode "$image")
        path="${API_BASE}/images/pull?reference=${image_enc}"

        curl -s -m 300 --unix-socket "$SOCKET" -X POST "http://localhost${path}"
        ;;
    volume_export)
        volumeName="$2"

        require_param volumeName "$volumeName"

        validate_volume_name "$volumeName"

        /usr/bin/podman volume export "$volumeName"
        ;;
    volume_import)
        volumeName="$2"
        volumeData="$4"
        compressed="$3"

        require_param volumeName "$volumeName"
        require_param volumeData "$volumeData"
        require_param compressed "$compressed"

        validate_volume_name "$volumeName"
        validate_base64_content "$volumeData"
        validate_int "$compressed"

        if [ "$compressed" = "1" ]; then
			data_decoded=$(echo "$volumeData" | base64 -d - | gunzip -c)
		else
			data_decoded=$(echo "$volumeData" | base64 -d -)
		fi
		decode_exit=$?

        if [ $decode_exit -ne 0 ]; then
            echo "Failed to decode import data"
            exit 1
        fi

        /usr/bin/podman volume exists "$volumeName" 2>/dev/null || \
            /usr/bin/podman volume create "$volumeName" > /dev/null 2>&1

        echo "$data_decoded" | /usr/bin/podman volume import "$volumeName" -
        exit_code=$?

        if [ $exit_code -ne 0 ]; then
            /usr/bin/podman volume rm "$volumeName" 2>/dev/null
            echo "Import failed"
            exit 1
        fi

        ;;
    *)
        echo "Unknown action: $action" >&2
        exit 1
        ;;
esac
