#!/usr/bin/env ucode

'use strict';

import { popen, writefile, unlink } from 'fs';

function die(msg) {
	warn(`${msg}\n`);
	exit(1);
}

function validate_int(val) {
	if (!val || !match(val, /^[0-9]+$/))
		die('Invalid number');
}

function validate_volume_name(name) {
	if (!name || !match(name, /^[a-zA-Z0-9_.-]+$/))
		die('Invalid volume name format');
}

// --- Main ---

let action = ARGV[0];

if (action === 'volume_export') {
	let volumeName = ARGV[1];
	if (!volumeName) die('Missing required parameter: volumeName');
	validate_volume_name(volumeName);

	// volume export outputs a tar stream â€” use podman CLI directly
	let escaped = replace(volumeName, /'/g, "'\\''");
	let p = popen(`/usr/bin/podman volume export '${escaped}'`, 'r');
	if (!p)
		die('Failed to run podman volume export');

	let chunk;
	while ((chunk = p.read(65536)) != null && length(chunk) > 0)
		print(chunk);
	p.close();
}
else if (action === 'volume_import') {
	let volumeName = ARGV[1];
	let compressed = ARGV[2];
	let volumeData = ARGV[3];

	if (!volumeName) die('Missing required parameter: volumeName');
	if (!volumeData) die('Missing required parameter: volumeData');
	if (!compressed) die('Missing required parameter: compressed');

	validate_volume_name(volumeName);
	validate_int(compressed);

	// Validate base64 content
	if (!match(volumeData, /^[A-Za-z0-9+\/]*={0,2}$/) || (length(volumeData) % 4) !== 0)
		die('Invalid Base64 content');

	let decoded = b64dec(volumeData);
	if (decoded == null)
		die('Failed to decode import data');

	// Decompress if needed
	if (compressed === '1') {
		let tp = popen('mktemp /tmp/podman_import_XXXXXX', 'r');
		let tmppath = tp ? trim(tp.read('all') || '') : '';
		if (tp) tp.close();
		if (!tmppath)
			die('Failed to create temp file');

		writefile(tmppath, decoded);

		let p = popen(`gunzip -c '${tmppath}'`, 'r');
		decoded = p ? p.read('all') : null;
		if (p) p.close();
		unlink(tmppath);

		if (!decoded)
			die('Failed to decompress import data');
	}

	// Ensure volume exists
	let escaped = replace(volumeName, /'/g, "'\\''");
	let p = popen(`/usr/bin/podman volume exists '${escaped}' 2>/dev/null; echo $?`, 'r');
	let rc = p ? trim(p.read('all') || '') : '';
	if (p) p.close();

	if (rc !== '0') {
		p = popen(`/usr/bin/podman volume create '${escaped}' 2>/dev/null`, 'r');
		if (p) { p.read('all'); p.close(); }
	}

	// Import via stdin pipe
	p = popen(`/usr/bin/podman volume import '${escaped}' -`, 'w');
	if (!p)
		die('Failed to start volume import');
	p.write(decoded);
	let exit_code = p.close();

	if (exit_code) {
		// Cleanup on failure
		popen(`/usr/bin/podman volume rm '${escaped}' 2>/dev/null`, 'r')?.close();
		die('Import failed');
	}
}
else {
	die(`Unknown action: ${action}`);
}
